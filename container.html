<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Container Room - Heartwired</title>
  <style>
    body { background:black; margin:0; }
    #game-container { position:relative; width:800px; height:600px; margin:30px auto; background:black; }
    canvas { display:block; background:#000; }
    #dialogue-box {
      position:absolute; left:50%; bottom:36px; transform:translateX(-50%);
      width:70%; min-height:52px; border-radius:8px;
      background:rgba(0,0,0,0.8); color:#fff; padding:18px;
      text-align:center; font-family:monospace; font-size:1.2em; display:none; z-index:10;
      border:2px solid #fff; text-shadow:1px 2px #000;
    }
    #console { display:none; position:absolute; top:60px; left:50%; width:340px; transform:translateX(-50%);
      background:#111; color:#0fa; border:2px solid #333; border-radius:7px; z-index:11;
    }
    #console input { width:96%; background:#222; border:0; color:#6d6; padding:8px; font-size:1em; }
    #console-output { font-size:0.97em; min-height:16px; margin-top:5px;}
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game" width="800" height="600"></canvas>
    <img id="forest-bg"
      src="https://img.itch.zone/aW1hZ2UvMTIxNjU4LzU2MDM4MS5wbmc=/508x254%23mb/D6fip%2B.png"
      style="display:none; position:absolute; width:800px; height:600px; left:0; top:0; z-index:1;"
    />
    <img id="lever-img"
      src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Lever_icon.svg"
      style="display:none; position:absolute; width:46px; height:46px; z-index:3;"
    />
    <div id="dialogue-box"></div>
    <div id="console">
      <input id="console-input" placeholder="Type console command, then Enter" autocomplete="off"/>
      <div id="console-output"></div>
    </div>
    <audio id="click-sound" src="https://cdn.pixabay.com/audio/2022/09/27/audio_12b0fa72c3.mp3"></audio>
  </div>
<script>
const SPRITES = {
  right: "https://piskel-imgstore-b.appspot.com/img/2f52d168-6137-11f0-9e04-8745c3739ca1.gif",
  left: "https://piskel-imgstore-b.appspot.com/img/2f52d168-6137-11f0-9e04-8745c3739ca1.gif",
  up:   "https://piskel-imgstore-b.appspot.com/img/66129338-614a-11f0-b814-8745c3739ca1.gif",
  down: "https://piskel-imgstore-b.appspot.com/img/543aaec2-614d-11f0-92ae-8745c3739ca1.gif"
};

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const lever = document.getElementById('lever-img');
const dialogue = document.getElementById('dialogue-box');
const forestbg = document.getElementById('forest-bg');
const clickSound = document.getElementById('click-sound');
const con = document.getElementById('console');
const conin = document.getElementById('console-input');
const conout = document.getElementById('console-output');

let player = {
  x: 400, y: 300, vx: 0, vy: 0, speed: 2.3, dir: 'down', frame: 0, walking: false,
  sprite: new Image(), flip: false
};
player.sprite.src = SPRITES.down;

let keys = {}, canMove = true, movedFor = 0, lastMoveDir = '', 
    stoppedAt = null, lastFrame = Date.now(),
    idle_state = 0, lever_spawned = false, lever_used = false;

// Controls
document.addEventListener("keydown", e => {
  if(e.key === '/') { showConsole(); e.preventDefault(); return; }
  if(e.repeat) return;
  keys[e.key.toLowerCase()] = true;
});
document.addEventListener("keyup", e => { keys[e.key.toLowerCase()] = false; });
conin && conin.addEventListener("keydown", e=>{
  if(e.key==='Escape'){hideConsole();return;}
  if(e.key==='Enter'){
    let val=conin.value.trim().toLowerCase();
    if(val==="help"){conout.textContent="help whoami lever exit";}
    else if(val==="whoami"){conout.textContent="You're the player.";}
    else if(val==="lever"){conout.textContent=lever_spawned?"It's right there!":"Not yet.";}
    else if(val==="exit"){hideConsole();}
    else{conout.textContent="Unknown";}
    conin.value="";
  }
});

function showConsole(){
  con.style.display = "block"; conin.value=""; conout.textContent="";
  conin.focus(); canMove = false;
}
function hideConsole(){ con.style.display = "none"; canMove = true; }

// ==== Drawing
function drawPlayer() {
  ctx.save();
  if(player.flip) {
    ctx.translate(player.x+48, player.y-48);
    ctx.scale(-1,1);
    ctx.drawImage(player.sprite, 0, 0, 96,96);
  } else {
    ctx.drawImage(player.sprite, player.x-48, player.y-48, 96,96);
  }
  ctx.restore();
}

function draw() {
  ctx.clearRect(0, 0, 800, 600);
  // If forest background is shown, draw under everything
  if(forestbg.style.display!=="none"){ctx.drawImage(forestbg, 0, 0, 800, 600);}
  drawPlayer();
}

// ==== Main Update
function update(){
  let now = Date.now(), dt = (now-lastFrame)/1000;
  lastFrame = now;
  let prev_x = player.x, prev_y = player.y;
  player.walking = false;
  let wasMoving = (player.vx!==0||player.vy!==0);
  if(canMove && !lever_used){
    // RPG Movement
    let vx=0,vy=0,ndir=player.dir, anyMove=false;
    if(keys['arrowup']||keys['w']) vy--, ndir='up', anyMove=true;
    if(keys['arrowdown']||keys['s']) vy++, ndir='down', anyMove=true;
    if(keys['arrowleft']||keys['a']) vx--, ndir='left', anyMove=true;
    if(keys['arrowright']||keys['d']) vx++, ndir='right', anyMove=true;

    // walking for 3s in one direction blocks further walk for 0.7s
    if(anyMove && ndir === lastMoveDir) movedFor += dt;
    else { movedFor=0; lastMoveDir=ndir; }
    if(movedFor > 3) { canMove=false; movedFor=0; setTimeout(()=>canMove=true,700); return;}
    
    // walk and animate sprite
    player.vx = vx*player.speed; player.vy = vy*player.speed;
    player.x = Math.max(48, Math.min(800-48, player.x+player.vx));
    player.y = Math.max(48, Math.min(600-48, player.y+player.vy));

    if(vx!==0||vy!==0){
      player.walking = true;
      player.dir = ndir;
      player.sprite.src = SPRITES[ndir];
      player.flip = (ndir==='left');
      stoppedAt = null;
    }else if(!player.walking){
      if(!stoppedAt) stoppedAt = now;
    }
  }

  // Idle / Not moving
  if(!player.walking && !lever_spawned){
    const idleElapsed = stoppedAt ? (now-stoppedAt)/1000 : 0;
    if(idle_state < 1 && idleElapsed>10){
      showDialogue("You waiting for something?");
      idle_state = 1;
    }else if(idle_state < 2 && idleElapsed>15){
      showDialogue("But still.. nothing!");
      idle_state = 2;
    }else if(idle_state < 3 && idleElapsed>18){
      showDialogue("OKAY, okay... Fine! We'll have it your way!");
      idle_state = 3;
      setTimeout(()=>{ dialogue.style.display="none"; addLever(); },1400);
    }
  }

  // Lever interaction
  if(lever_spawned && !lever_used){
    // Check player is pressed against it
    const l = lever.getBoundingClientRect(), c = canvas.getBoundingClientRect();
    let lx = lever.offsetLeft+23, ly = lever.offsetTop+23;
    let dx = Math.abs(player.x-lx), dy = Math.abs(player.y-ly);
    if(dx<44 && dy<44 && keys[' ']){
      // Use lever
      lever_used = true;
      clickSound.play();
      lever.style.display = "none";
      // Reveal forest background
      forestbg.style.display = "block";
      showDialogue("You are in a forest now.");
      setTimeout(()=>{ dialogue.style.display="none"; },1200);
    }
  }

  draw();
  requestAnimationFrame(update);
}

// ==== Lever logic
function addLever(){
  let lx = player.x-23, ly = player.y+44;
  lever.style.left = `${lx}px`; lever.style.top = `${ly}px`;
  lever.style.display = "";
  lever_spawned = true;
}

// ==== Dialogue
function showDialogue(text){
  dialogue.style.display="block"; dialogue.innerText=text;
}

window.onload = ()=>{
  // Initial setup
  forestbg.style.display="none";
  lever.style.display="none";
  dialogue.style.display="none";
  player.sprite.src = SPRITES.down;
  lastFrame = Date.now();
  update();
};
</script>
</body>
</html>
