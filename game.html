<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Heartwired Scene</title>
<style>
  @font-face {
    font-family: 'PixelFont';
    src: url('https://fonts.cdnfonts.com/s/17154/PressStart2P-Regular.ttf') format('truetype');
    font-display: swap;
  }
  body {
    background: #000; margin: 0; overflow: hidden; height: 100vh; width: 100vw;
    font-family: 'PixelFont', monospace;
    user-select: none;
  }
  #white-fade {
    position:fixed;top:0;left:0;width:100vw;height:100vh;
    background:#fff; z-index:20;
    opacity:1; transition:opacity 3s linear;
  }
  #game-scene {
    position: absolute;top:0;left:0;width:100vw;height:100vh;z-index:10;
    display:flex;justify-content:center;align-items:center;background:#000;
  }
  .sprite {
    image-rendering: pixelated; image-rendering: crisp-edges;
    position: absolute; left:50%; top:70%; transform:translate(-50%,-50%);
    opacity: 0; transition: opacity 0.2s;
    width:96px; height:96px;
  }
  #player-up {
    display:none;
    transform: translate(-50%, -50%) scaleX(0.92) scaleY(1.22);
  }
  #typewriter-container {
    position: absolute; left: 50%; top: 60%;
    transform: translate(-50%, -50%);
    padding: 32px;
    color: #fff;
    font-size: 1.2em;
    background: rgba(0,0,0,0.8);
    border-radius: 8px;
    min-width: 600px;
    min-height: 120px;
    letter-spacing: 1.5px;
    z-index: 6;
    opacity: 0;
    transition: opacity 1.4s;
    font-family: 'PixelFont', monospace;
    border: 2px solid #fff;
    white-space: pre-line;
    text-shadow: 2px 2px #1b0103;
  }
  #prompt {
    color: #aaa;
    font-size: 0.8em;
    padding-top: 10px;
    opacity: 0.7;
    font-family: 'PixelFont', monospace;
    text-align: center;
    letter-spacing: 1.2px;
  }
</style>
</head>
<body>
<div id="white-fade"></div>
<div id="game-scene">
  <img id="player-floor" class="sprite"
    src="https://piskel-imgstore-b.appspot.com/img/6d8b9acc-6154-11f0-822d-8745c3739ca1.gif" />
  <img id="player-up" class="sprite"
    src="https://piskel-imgstore-b.appspot.com/img/96330770-6155-11f0-a252-8745c3739ca1.gif"/>
</div>
<div id="typewriter-container"></div>
<script>
const whiteFade = document.getElementById('white-fade');
const playerFloor = document.getElementById('player-floor');
const playerUp = document.getElementById('player-up');
const typewriterContainer = document.getElementById('typewriter-container');

const DIALOGUE = [
  "Once upon a time, a young girl named Kaylee was just listening to some music in her room, and doing nothing but enjoying life.",
  "",
  "When out of nowhere she blinked and was gone from her room, instead just a pitch black room. No lights, no vision, or anything from her room!",
  "",
  "Where could she have gone, what could have happened...?"
];

// Controls for dialogue display
let currentLine = 0;
let isTyping = false;
let typingDone = false;
let fullLine = '';
let currentTimeout = null;
let prompt;

async function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }

function renderPrompt(msg) {
  if (!prompt) {
    prompt = document.createElement("div");
    prompt.setAttribute('id', 'prompt');
    typewriterContainer.appendChild(prompt);
  }
  prompt.innerText = msg;
}

function clearPrompt() {
  if (prompt) prompt.innerText = '';
}

// Typewriter logic with skip/advance support
async function typeWriterLine(line) {
  isTyping = true;
  typingDone = false;
  fullLine = line;
  typewriterContainer.innerHTML = '';
  clearPrompt();

  return new Promise(resolve => {
    let i = 0, length = line.length;
    let skip = false;
    function write() {
      if (skip) {
        typewriterContainer.innerHTML = line;
        isTyping = false;
        typingDone = true;
        renderPrompt("[SPACE] Continue");
        resolve();
        return;
      }
      if (i < length) {
        typewriterContainer.innerHTML += line[i];
        i++;
        currentTimeout = setTimeout(write, 22 + Math.random() * 15);
      } else {
        isTyping = false;
        typingDone = true;
        renderPrompt("[SPACE] Continue");
        resolve();
      }
    }
    // ENTER to skip instantly
    function onKeyDown(e) {
      if (isTyping && (e.key === 'Enter')) {
        skip = true;
        clearTimeout(currentTimeout);
        document.removeEventListener('keydown', onKeyDown);
        write(); // Show all text
      }
    }
    document.addEventListener('keydown', onKeyDown);
    write();
  });
}

function showNextLine() {
  if (currentLine < DIALOGUE.length) {
    // Only display prompt if not empty line
    if (DIALOGUE[currentLine].trim() !== '') {
      renderPrompt("[SPACE] Continue  |  [ENTER] Skip");
    } else {
      clearPrompt();
    }
    return typeWriterLine(DIALOGUE[currentLine++]);
  }
  return Promise.resolve(false);
}

// Main scene logic
async function scene() {
  await sleep(1000);
  whiteFade.style.opacity = 0;
  await sleep(3000);

  playerFloor.style.opacity = 1;
  await sleep(4000);

  await shake(playerFloor, 1, 24, 35);
  await sleep(160);
  await shake(playerFloor, 2, 18, 30);

  playerFloor.style.opacity = 0;
  await sleep(50);
  playerFloor.style.display = 'none';
  playerUp.style.display = '';
  playerUp.style.opacity = 1;

  typewriterContainer.style.opacity = 1;

  // Dialogue Loop
  while (currentLine < DIALOGUE.length) {
    await showNextLine();
    // Wait for SPACE to continue
    await new Promise(res=>{
      function onSpace(e) {
        if ((e.key === ' ' || e.code === 'Space') && !isTyping && typingDone) {
          document.removeEventListener('keydown', onSpace);
          clearPrompt();
          res();
        }
      }
      document.addEventListener('keydown', onSpace);
    });
    // Clear line before showing next (skip clearing for empty lines)
    if (DIALOGUE[currentLine-1].trim() !== '') typewriterContainer.innerHTML = "";
  }

  // Fade to white - end of sequence example
  await sleep(900);
  whiteFade.style.transition = "opacity 2.5s linear";
  whiteFade.style.opacity = 1;

  // Continue with your game logic here...
}

// Shake function same as before
async function shake(el, times, dist, speed) {
  const orig = el.style.transform || "translate(-50%, -50%)";
  for (let i = 0; i < times; ++i) {
    el.style.transform = "translate(-50%, -50%) translateX("+(-dist)+"px)";
    await sleep(speed);
    el.style.transform = "translate(-50%, -50%) translateX("+(dist)+"px)";
    await sleep(speed);
  }
  el.style.transform = orig;
}

scene();
</script>
</body>
</html>
